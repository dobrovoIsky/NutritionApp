<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:NutritionApp.Converters"
             x:Class="NutritionApp.Views.MealPlanPage"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{StaticResource PageBackground}">

    <!-- Resources ÐŸÐ•Ð Ð•Ð” ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð¼ -->
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
    </ContentPage.Resources>

    <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ¸ -->
    <Grid RowDefinitions="180,*" Padding="0">

        <!-- Ð’ÐµÑ€Ñ…Ð½Ñ–Ð¹ Ð±Ð»Ð¾Ðº Ð· Ð³Ñ€Ð°Ð´Ñ–Ñ”Ð½Ñ‚Ð¾Ð¼ -->
        <Grid Row="0" Padding="0,16,0,16">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#4F7DFF" Offset="0.0" />
                    <GradientStop Color="#E27D5F" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>

            <VerticalStackLayout Spacing="10"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center">
                <Label Text="ðŸ½ï¸" FontSize="40" HorizontalOptions="Center"/>
                <Label Text="ÐŸÐ»Ð°Ð½ Ñ…Ð°Ñ€Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ"
                       FontAttributes="Bold"
                       FontSize="24"
                       TextColor="White"
                       HorizontalOptions="Center"/>
                <Label Text="ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ñ–Ð·Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ñ€Ð°Ñ†Ñ–Ð¾Ð½ Ð²Ñ–Ð´ AI"
                       FontSize="14"
                       TextColor="#FFEFF2"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>

        <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ -->
        <Border Grid.Row="1"
                BackgroundColor="{StaticResource CardBackground}"
                Stroke="{StaticResource BorderColor}"
                StrokeThickness="1"
                Padding="16"
                Margin="16,-32,16,16"
                StrokeShape="RoundRectangle 24">

            <Grid RowDefinitions="Auto,*">

                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ— (Ð±ÐµÐ· Ñ„Ð¾Ñ‚Ð¾) -->
                <Border Grid.Row="0"
        StrokeShape="RoundRectangle 14"
        Stroke="Transparent"
        BackgroundColor="{StaticResource Primary}"
        Padding="16,14"
        Margin="0,0,0,16">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding GeneratePlanCommand}" />
                    </Border.GestureRecognizers>
                    <Label Text="âœ¨ Ð—Ð³ÐµÐ½ÐµÑ€ÑƒÐ²Ð°Ñ‚Ð¸ Ð½Ð¾Ð²Ð¸Ð¹ Ð¿Ð»Ð°Ð½"
           HorizontalOptions="Center"
           VerticalOptions="Center"
           TextColor="Black" 
           FontAttributes="Bold"
           FontSize="16"/>
                </Border>

                <!-- Ð¡ÐºÑ€Ð¾Ð»ÑŽÐ²Ð°Ð½Ð¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ -->
                <ScrollView Grid.Row="1">
                    <VerticalStackLayout Spacing="16">

                        <!-- Ð†Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ -->
                        <VerticalStackLayout IsVisible="{Binding IsLoading}" 
                                             Spacing="12"
                                             HorizontalOptions="Center"
                                             Margin="0,40,0,0">
                            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                               Color="{StaticResource Primary}"
                                               HeightRequest="50"
                                               WidthRequest="50"/>
                            <Label Text="ðŸ¤– AI Ð³ÐµÐ½ÐµÑ€ÑƒÑ” Ñ‚Ð²Ñ–Ð¹ Ð¿Ð»Ð°Ð½..."
                                   FontSize="16"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Ð¦Ðµ Ð¼Ð¾Ð¶Ðµ Ð·Ð°Ð¹Ð½ÑÑ‚Ð¸ Ð´Ð¾ 30 ÑÐµÐºÑƒÐ½Ð´"
                                   FontSize="13"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <!-- ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ -->
                        <Border IsVisible="{Binding HasError}"
                                BackgroundColor="#FEF2F2"
                                Stroke="#FECACA"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 12"
                                Padding="16">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="#DC2626"/>
                                <Label Text="{Binding ErrorMessage}"
                                       FontSize="14"
                                       TextColor="#991B1B"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Summary -->
                        <Label Text="{Binding Summary}"
                               IsVisible="{Binding HasData}"
                               FontSize="15"
                               TextColor="{StaticResource TextSecondary}"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"
                               Margin="0,0,0,8"/>

                        <!-- ÐŸÑ€Ð¸Ð¹Ð¾Ð¼Ð¸ Ñ—Ð¶Ñ– -->
                        <CollectionView ItemsSource="{Binding Meals}"
                                        IsVisible="{Binding HasData}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Stroke="{StaticResource BorderColor}"
                                            BackgroundColor="{StaticResource CardBackground}"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 16"
                                            Padding="16"
                                            Margin="0,0,0,12">
                                        <VerticalStackLayout Spacing="12">

                                            <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ð¿Ñ€Ð¸Ð¹Ð¾Ð¼Ñƒ Ñ—Ð¶Ñ– -->
                                            <Grid ColumnDefinitions="*,Auto">
                                                <HorizontalStackLayout Spacing="8">
                                                    <Label Text="ðŸ´" FontSize="18"/>
                                                    <Label Text="{Binding Name}"
                                                           FontSize="17"
                                                           FontAttributes="Bold"
                                                           TextColor="{StaticResource TextPrimary}"/>
                                                </HorizontalStackLayout>
                                                <Border Grid.Column="1"
                                                        BackgroundColor="#EFF6FF"
                                                        StrokeShape="RoundRectangle 10"
                                                        Stroke="Transparent"
                                                        Padding="8,4">
                                                    <Label Text="{Binding Time}"
                                                           FontSize="13"
                                                           TextColor="{StaticResource Primary}"
                                                           FontAttributes="Bold"/>
                                                </Border>
                                            </Grid>

                                            <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ–Ð² -->
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Foods}"
                                                                 Spacing="6">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border BackgroundColor="{StaticResource PageBackground}"
                                                                StrokeShape="RoundRectangle 10"
                                                                Stroke="Transparent"
                                                                Padding="12">
                                                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                                                                <Label Text="{Binding Name}"
                                                                       FontSize="15"
                                                                       FontAttributes="Bold"
                                                                       TextColor="{StaticResource TextPrimary}"/>
                                                                <Label Grid.Column="1"
                                                                       Text="{Binding Weight}"
                                                                       FontSize="13"
                                                                       TextColor="{StaticResource TextSecondary}"/>

                                                                <HorizontalStackLayout Grid.Row="1" 
                                                                                       Grid.ColumnSpan="2"
                                                                                       Spacing="12"
                                                                                       Margin="0,4,0,0">
                                                                    <Label Text="{Binding Calories, StringFormat='ðŸ”¥ {0} ÐºÐºÐ°Ð»'}"
                                                                           FontSize="12" 
                                                                           TextColor="#EA580C"/>
                                                                    <Label Text="{Binding Protein, StringFormat='Ð‘: {0}'}"
                                                                           FontSize="12" 
                                                                           TextColor="#16A34A"/>
                                                                    <Label Text="{Binding Fat, StringFormat='Ð–: {0}'}"
                                                                           FontSize="12" 
                                                                           TextColor="#CA8A04"/>
                                                                    <Label Text="{Binding Carbs, StringFormat='Ð’: {0}'}"
                                                                           FontSize="12" 
                                                                           TextColor="#2563EB"/>
                                                                </HorizontalStackLayout>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>

                                            <!-- Ð—Ð°Ð³Ð°Ð»ÑŒÐ½Ñ– ÐºÐ°Ð»Ð¾Ñ€Ñ–Ñ— Ð¿Ñ€Ð¸Ð¹Ð¾Ð¼Ñƒ -->
                                            <Border BackgroundColor="#FFF7ED"
                                                    StrokeShape="RoundRectangle 8"
                                                    Stroke="Transparent"
                                                    Padding="10,6"
                                                    HorizontalOptions="End">
                                                <Label Text="{Binding TotalCalories, StringFormat='Ð’ÑÑŒÐ¾Ð³Ð¾: {0} ÐºÐºÐ°Ð»'}"
                                                       FontSize="13" 
                                                       TextColor="#EA580C" 
                                                       FontAttributes="Bold"/>
                                            </Border>

                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- ÐŸÐ¾Ñ‡Ð°Ñ‚ÐºÐ¾Ð²Ðµ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ (ÐºÐ¾Ð»Ð¸ Ð½ÐµÐ¼Ð°Ñ” Ð´Ð°Ð½Ð¸Ñ… Ñ– Ð½Ðµ Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ñ‚ÑŒÑÑ) -->
                        <VerticalStackLayout IsVisible="{Binding ShowInitialMessage}"
                                             Spacing="16"
                                             HorizontalOptions="Center"
                                             Margin="0,40,0,0">
                            <Label Text="ðŸ¥—" FontSize="60" HorizontalOptions="Center"/>
                            <Label Text="ÐÐ°Ñ‚Ð¸ÑÐ½Ñ–Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ, Ñ‰Ð¾Ð± Ð·Ð³ÐµÐ½ÐµÑ€ÑƒÐ²Ð°Ñ‚Ð¸ Ð¿Ð»Ð°Ð½ Ñ…Ð°Ñ€Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ."
                                   FontSize="16"
                                   TextColor="{StaticResource TextSecondary}"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>

                    </VerticalStackLayout>
                </ScrollView>

            </Grid>
        </Border>

    </Grid>
</ContentPage>